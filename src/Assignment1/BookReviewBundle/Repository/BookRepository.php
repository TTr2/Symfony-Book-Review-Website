<?php

namespace Assignment1\BookReviewBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * BookRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BookRepository extends EntityRepository
{
    /**
     * Query to aggregate review ratings for a book
     * @param $bookId
     */
    public function queryAverageBookReviewRating($bookId)
    {
        $erReview = $this->getEntityManager()->getRepository('BookReviewBundle:Review');
        $query = $erReview->createQueryBuilder('ra')
            ->select('avg(ra.rating)')
            ->where('ra.book = :bookId')
            ->setParameter(":bookId", $bookId)
            ->getQuery();

        return $query->getResult();
    }

    /**
     * Query to count number of review ratings for a book
     * @param $bookId
     */
    public function queryCountBookReviews($bookId)
    {
        $er = $this->getEntityManager()->getRepository('BookReviewBundle:Review');
        $query = $er->createQueryBuilder('rc')
            ->select('count(rc.id)')
            ->where('rc.book = :bookId')
            ->setParameter(":bookId", $bookId)
            ->getQuery();

        return $query->getSingleScalarResult();
    }
}
